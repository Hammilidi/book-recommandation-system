{% extends "base.html" %}
{% block title %}Gestion des Emprunts{% endblock %}
{% block content %}
<div class="animate-slide-up">
    <!-- Header -->
    <div class="glass-effect rounded-3xl p-8 mb-8 border border-white/30 hover-lift">
        <div class="flex flex-col lg:flex-row items-center justify-between">
            <div>
                <h1 class="gradient-text text-5xl font-black mb-3 leading-tight">
                    Gestion des emprunts üîÑ
                </h1>
                <p class="text-gray-600 text-xl font-medium">
                    G√©rez efficacement les pr√™ts et retours de votre biblioth√®que
                </p>
            </div>
            <div class="mt-6 lg:mt-0 flex gap-3">
                <button onclick="showQuickActions()" class="bg-purple-500 text-white px-6 py-3 rounded-2xl font-bold shadow-lg hover:bg-purple-600 hover:scale-105 transform transition-all duration-300">
                    <i class="fas fa-bolt mr-2"></i>Actions rapides
                </button>
                <button onclick="generateReport()" class="primary-button text-white px-6 py-3 rounded-2xl font-bold shadow-xl hover:scale-105 transform transition-all duration-300">
                    <i class="fas fa-file-alt mr-2"></i>Rapport
                </button>
            </div>
        </div>
    </div>

    <!-- Quick Stats Dashboard -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="glass-effect rounded-2xl p-6 text-center border border-white/20 hover-lift">
            <div class="w-12 h-12 bg-blue-500 rounded-xl flex items-center justify-center mx-auto mb-3">
                <i class="fas fa-handshake text-white"></i>
            </div>
            <p class="text-3xl font-black text-gray-800" id="total-loans">{{ emprunts|length }}</p>
            <p class="text-sm text-gray-600 font-medium">Emprunts actifs</p>
        </div>
        <div class="glass-effect rounded-2xl p-6 text-center border border-white/20 hover-lift">
            <div class="w-12 h-12 bg-green-500 rounded-xl flex items-center justify-center mx-auto mb-3">
                <i class="fas fa-check-double text-white"></i>
            </div>
            <p class="text-3xl font-black text-gray-800" id="on-time-count">...</p>
            <p class="text-sm text-gray-600 font-medium">√Ä temps</p>
        </div>
        <div class="glass-effect rounded-2xl p-6 text-center border border-white/20 hover-lift">
            <div class="w-12 h-12 bg-red-500 rounded-xl flex items-center justify-center mx-auto mb-3">
                <i class="fas fa-exclamation-triangle text-white"></i>
            </div>
            <p class="text-3xl font-black text-gray-800" id="late-count">...</p>
            <p class="text-sm text-gray-600 font-medium">En retard</p>
        </div>
        <div class="glass-effect rounded-2xl p-6 text-center border border-white/20 hover-lift">
            <div class="w-12 h-12 bg-orange-500 rounded-xl flex items-center justify-center mx-auto mb-3">
                <i class="fas fa-undo text-white"></i>
            </div>
            <p class="text-3xl font-black text-gray-800">142</p>
            <p class="text-sm text-gray-600 font-medium">Retours ce mois</p>
        </div>
    </div>

    <!-- Action Cards -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <!-- New Loan Card -->
        <div class="glass-effect rounded-3xl p-8 border border-white/30 hover-lift">
            <h2 class="text-2xl font-black text-gray-800 mb-6 flex items-center">
                <i class="fas fa-plus-circle mr-3 text-blue-500"></i>Nouveau pr√™t
            </h2>
            
            <form id="emprunt-form" class="space-y-6">
                <div>
                    <label for="adherent-select" class="block text-gray-700 font-bold mb-2">S√©lectionner l'adh√©rent</label>
                    <select id="adherent-select" name="id_adherent" 
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-2xl focus:ring-4 focus:ring-blue-200 focus:border-blue-500 transition-all duration-300 bg-white/90 backdrop-blur font-medium">
                        <option value="">Choisir un adh√©rent...</option>
                        {% for adherent in adherents %}
                            <option value="{{ adherent.id }}">{{ adherent.nom }} ({{ adherent.email }})</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div>
                    <label for="livre-select" class="block text-gray-700 font-bold mb-2">S√©lectionner le livre</label>
                    <select id="livre-select" name="id_livre" 
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-2xl focus:ring-4 focus:ring-blue-200 focus:border-blue-500 transition-all duration-300 bg-white/90 backdrop-blur font-medium">
                        <option value="">Choisir un livre...</option>
                        {% for livre in livres %}
                            {% if livre.disponibilite > 0 %}
                                <option value="{{ livre.id }}">{{ livre.titre }} ({{ livre.disponibilite }} dispo.)</option>
                            {% endif %}
                        {% endfor %}
                    </select>
                </div>
                
                <div>
                    <label for="date-retour-prevue" class="block text-gray-700 font-bold mb-2">Date de retour pr√©vue</label>
                    <input type="date" id="date-retour-prevue" name="date_retour_prevue" 
                           class="w-full px-4 py-3 border-2 border-gray-200 rounded-2xl focus:ring-4 focus:ring-blue-200 focus:border-blue-500 transition-all duration-300 bg-white/90 backdrop-blur font-medium">
                </div>
                
                <button type="submit" class="w-full primary-button text-white font-bold py-4 px-6 rounded-2xl shadow-xl hover:scale-105 transform transition-all duration-300 text-lg">
                    <i class="fas fa-handshake mr-3"></i>Enregistrer le pr√™t
                </button>
            </form>
            
            <div id="emprunt-message" class="mt-6 text-center"></div>
        </div>

        <!-- Return Loan Card -->
        <div class="glass-effect rounded-3xl p-8 border border-white/30 hover-lift">
            <h2 class="text-2xl font-black text-gray-800 mb-6 flex items-center">
                <i class="fas fa-undo-alt mr-3 text-green-500"></i>Enregistrer un retour
            </h2>
            
            <form id="retour-form" class="space-y-6">
                <div>
                    <label for="emprunt-select" class="block text-gray-700 font-bold mb-2">S√©lectionner l'emprunt</label>
                    <select id="emprunt-select" name="emprunt_id" 
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-2xl focus:ring-4 focus:ring-green-200 focus:border-green-500 transition-all duration-300 bg-white/90 backdrop-blur font-medium">
                        <option value="">Choisir un emprunt en cours...</option>
                        {% for emprunt in emprunts %}
                            {% if not emprunt.date_retour_effectif %}
                                <option value="{{ emprunt.id }}" 
                                        class="{% if emprunt.date_retour_prevue < now %}text-red-600{% endif %}">
                                    {{ emprunt.adherent.nom }} - {{ emprunt.livre.titre }} 
                                    (Retour: {{ emprunt.date_retour_prevue.strftime('%d/%m/%Y') }})
                                    {% if emprunt.date_retour_prevue < now %} - EN RETARD{% endif %}
                                </option>
                            {% endif %}
                        {% endfor %}
                    </select>
                </div>
                
                <div class="bg-yellow-50 border border-yellow-200 rounded-2xl p-4">
                    <div class="flex items-center">
                        <i class="fas fa-info-circle text-yellow-600 mr-3"></i>
                        <p class="text-yellow-800 font-medium text-sm">
                            Les retours en retard peuvent n√©cessiter des frais suppl√©mentaires.
                        </p>
                    </div>
                </div>
                
                <button type="submit" class="w-full bg-green-500 text-white font-bold py-4 px-6 rounded-2xl shadow-xl hover:bg-green-600 hover:scale-105 transform transition-all duration-300 text-lg">
                    <i class="fas fa-check-circle mr-3"></i>Confirmer le retour
                </button>
            </form>
            
            <div id="retour-message" class="mt-6 text-center"></div>
        </div>
    </div>

    <!-- Active Loans Table -->
    <div class="glass-effect rounded-3xl p-8 border border-white/30 hover-lift">
        <!-- Search and Filter -->
        <div class="flex flex-col md:flex-row gap-4 mb-8">
            <div class="flex-1 relative">
                <input type="text" id="search-loans" placeholder="Rechercher par adh√©rent ou livre..." 
                       class="w-full pl-12 pr-4 py-3 border-2 border-gray-200 rounded-2xl focus:ring-4 focus:ring-blue-200 focus:border-blue-500 transition-all duration-300 bg-white/90 backdrop-blur font-medium">
                <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                    <i class="fas fa-search text-gray-400"></i>
                </div>
            </div>
            <div class="flex gap-3">
                <select id="filter-status" class="px-4 py-3 border-2 border-gray-200 rounded-2xl focus:ring-4 focus:ring-blue-200 focus:border-blue-500 transition-all duration-300 bg-white/90 backdrop-blur font-medium">
                    <option value="">Tous les emprunts</option>
                    <option value="on-time">√Ä temps</option>
                    <option value="late">En retard</option>
                </select>
                <button onclick="refreshLoans()" class="bg-blue-500 text-white px-6 py-3 rounded-2xl font-semibold hover:bg-blue-600 transition duration-300 shadow-lg">
                    <i class="fas fa-sync-alt mr-2"></i>Actualiser
                </button>
            </div>
        </div>
        
        <h2 class="text-3xl font-black text-gray-800 mb-6 flex items-center">
            <i class="fas fa-list-alt mr-3 text-purple-500"></i>Emprunts en cours
        </h2>
        
        <div class="overflow-x-auto">
            <table class="min-w-full">
                <thead>
                    <tr class="bg-gradient-to-r from-gray-100 to-gray-200">
                        <th class="px-6 py-4 text-left text-sm font-black text-gray-700 uppercase tracking-wider rounded-l-2xl">
                            <i class="fas fa-user mr-2"></i>Adh√©rent
                        </th>
                        <th class="px-6 py-4 text-left text-sm font-black text-gray-700 uppercase tracking-wider">
                            <i class="fas fa-book mr-2"></i>Livre
                        </th>
                        <th class="px-6 py-4 text-left text-sm font-black text-gray-700 uppercase tracking-wider">
                            <i class="fas fa-calendar-alt mr-2"></i>Dates
                        </th>
                        <th class="px-6 py-4 text-left text-sm font-black text-gray-700 uppercase tracking-wider">
                            <i class="fas fa-signal mr-2"></i>Statut
                        </th>
                        <th class="px-6 py-4 text-center text-sm font-black text-gray-700 uppercase tracking-wider rounded-r-2xl">
                            <i class="fas fa-cogs mr-2"></i>Actions
                        </th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    {% for emprunt in emprunts %}
                        {% if not emprunt.date_retour_effectif %}
                            {% set is_late = emprunt.date_retour_prevue < now %}
                            <tr class="loan-row hover:bg-white/80 transition-all duration-300 group {{ 'bg-red-50/50' if is_late else '' }}" 
                                data-adherent="{{ emprunt.adherent.nom|lower }}" 
                                data-livre="{{ emprunt.livre.titre|lower }}"
                                data-status="{{ 'late' if is_late else 'on-time' }}">
                                <td class="px-6 py-6">
                                    <div class="flex items-center">
                                        <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-teal-600 rounded-xl flex items-center justify-center mr-4 shadow-lg group-hover:scale-110 transition-transform duration-300">
                                            <i class="fas fa-user text-white"></i>
                                        </div>
                                        <div>
                                            <div class="font-bold text-gray-900 text-lg">{{ emprunt.adherent.nom }}</div>
                                            <div class="text-gray-600 text-sm font-medium">{{ emprunt.adherent.email }}</div>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-6">
                                    <div class="flex items-center">
                                        <img src="{{ emprunt.livre.image_url }}" alt="{{ emprunt.livre.titre }}" 
                                             class="w-12 h-16 object-cover rounded-lg shadow-md mr-4 group-hover:scale-110 transition-transform duration-300">
                                        <div>
                                            <div class="font-bold text-gray-900">{{ emprunt.livre.titre }}</div>
                                            <div class="text-gray-600 text-sm font-medium">ID: #{{ emprunt.livre.id }}</div>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-6">
                                    <div class="space-y-1">
                                        <div class="font-semibold text-gray-800 flex items-center">
                                            <i class="fas fa-calendar-day mr-2 text-blue-500"></i>
                                            {{ emprunt.date_emprunt.strftime('%d/%m/%Y') }}
                                        </div>
                                        <div class="font-semibold text-gray-800 flex items-center {{ 'text-red-600' if is_late else '' }}">
                                            <i class="fas fa-calendar-check mr-2 {{ 'text-red-500' if is_late else 'text-green-500' }}"></i>
                                            {{ emprunt.date_retour_prevue.strftime('%d/%m/%Y') }}
                                        </div>
                                        {% if is_late %}
                                            {% set days_late = (now - emprunt.date_retour_prevue).days %}
                                            <div class="text-red-600 text-sm font-bold">
                                                <i class="fas fa-exclamation-triangle mr-1"></i>
                                                {{ days_late }} jour{{ 's' if days_late != 1 else '' }} de retard
                                            </div>
                                        {% endif %}
                                    </div>
                                </td>
                                <td class="px-6 py-6">
                                    {% if is_late %}
                                        <span class="inline-flex items-center px-4 py-2 rounded-full text-sm font-bold bg-red-100 text-red-800 animate-pulse">
                                            <i class="fas fa-exclamation-triangle mr-2"></i>En retard
                                        </span>
                                    {% else %}
                                        <span class="inline-flex items-center px-4 py-2 rounded-full text-sm font-bold bg-green-100 text-green-800">
                                            <i class="fas fa-check-circle mr-2"></i>√Ä temps
                                        </span>
                                    {% endif %}
                                </td>
                                <td class="px-6 py-6 text-center">
                                    <div class="flex justify-center space-x-2">
                                        <button onclick="processReturn({{ emprunt.id }})" 
                                                class="bg-green-500 text-white px-4 py-2 rounded-xl hover:bg-green-600 transition duration-300 shadow-md hover:scale-110 transform font-semibold" 
                                                title="Traiter le retour">
                                            <i class="fas fa-undo mr-1"></i>Retour
                                        </button>
                                        
                                        <button onclick="extendLoan({{ emprunt.id }})" 
                                                class="bg-blue-500 text-white px-4 py-2 rounded-xl hover:bg-blue-600 transition duration-300 shadow-md hover:scale-110 transform font-semibold" 
                                                title="Prolonger l'emprunt">
                                            <i class="fas fa-clock mr-1"></i>Prolonger
                                        </button>
                                        
                                        <button onclick="sendReminder({{ emprunt.id }})" 
                                                class="bg-orange-500 text-white px-4 py-2 rounded-xl hover:bg-orange-600 transition duration-300 shadow-md hover:scale-110 transform font-semibold" 
                                                title="Envoyer un rappel">
                                            <i class="fas fa-bell mr-1"></i>Rappel
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        {% if emprunts|selectattr("date_retour_effectif", "none")|list|length == 0 %}
            <div class="text-center py-12">
                <div class="w-24 h-24 bg-gray-200 rounded-3xl flex items-center justify-center mx-auto mb-6">
                    <i class="fas fa-inbox text-4xl text-gray-400"></i>
                </div>
                <h3 class="text-2xl font-bold text-gray-700 mb-3">Aucun emprunt en cours</h3>
                <p class="text-gray-600 font-medium mb-6">Tous les livres ont √©t√© retourn√©s. Excellent travail !</p>
            </div>
        {% endif %}
    </div>
</div>

<!-- Extend Loan Modal -->
<div id="extend-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden transition-all duration-300">
    <div class="glass-effect rounded-3xl shadow-2xl p-8 w-full max-w-md border border-white/30 animate-bounce-in">
        <div class="text-center mb-6">
            <div class="w-16 h-16 bg-blue-500 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-clock text-white text-2xl"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-900 mb-2">Prolonger l'emprunt</h3>
            <p class="text-gray-600 font-medium">S√©lectionnez la nouvelle date de retour</p>
        </div>
        
        <form id="extend-form" class="space-y-6">
            <input type="hidden" id="extend-emprunt-id">
            <div>
                <label for="new-return-date" class="block text-gray-700 font-bold mb-2">Nouvelle date de retour</label>
                <input type="date" id="new-return-date" 
                       class="w-full px-4 py-3 border-2 border-gray-200 rounded-2xl focus:ring-4 focus:ring-blue-200 focus:border-blue-500 transition-all duration-300 bg-white/90 backdrop-blur font-medium">
            </div>
            
            <div class="flex gap-4">
                <button type="button" onclick="closeExtendModal()" class="flex-1 bg-gray-500 text-white py-3 px-6 rounded-2xl font-bold hover:bg-gray-600 transition duration-300">
                    <i class="fas fa-times mr-2"></i>Annuler
                </button>
                <button type="submit" class="flex-1 primary-button text-white py-3 px-6 rounded-2xl font-bold hover:scale-105 transform transition-all duration-300">
                    <i class="fas fa-save mr-2"></i>Prolonger
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Calculate loan stats
        const loans = document.querySelectorAll('.loan-row');
        let onTimeCount = 0;
        let lateCount = 0;
        
        loans.forEach(loan => {
            const status = loan.dataset.status;
            if (status === 'late') {
                lateCount++;
            } else {
                onTimeCount++;
            }
        });
        
        document.getElementById('on-time-count').textContent = onTimeCount;
        document.getElementById('late-count').textContent = lateCount;
        
        // Set default return date (2 weeks from today)
        const today = new Date();
        const defaultReturnDate = new Date(today.getTime() + (14 * 24 * 60 * 60 * 1000));
        document.getElementById('date-retour-prevue').value = defaultReturnDate.toISOString().split('T')[0];
        
        // Search functionality
        document.getElementById('search-loans').addEventListener('input', filterLoans);
        document.getElementById('filter-status').addEventListener('change', filterLoans);
    });
    
    function filterLoans() {
        const searchTerm = document.getElementById('search-loans').value.toLowerCase();
        const statusFilter = document.getElementById('filter-status').value;
        const rows = document.querySelectorAll('.loan-row');
        
        rows.forEach(row => {
            const adherent = row.dataset.adherent;
            const livre = row.dataset.livre;
            const status = row.dataset.status;
            
            const matchesSearch = !searchTerm || adherent.includes(searchTerm) || livre.includes(searchTerm);
            const matchesStatus = !statusFilter || status === statusFilter;
            
            if (matchesSearch && matchesStatus) {
                row.style.display = 'table-row';
                row.classList.add('animate-fade-in');
            } else {
                row.style.display = 'none';
                row.classList.remove('animate-fade-in');
            }
        });
    }
    
    // Form submissions
    document.getElementById('emprunt-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const messageDiv = document.getElementById('emprunt-message');
        
        try {
            const response = await fetch('/api/emprunts', { method: 'POST', body: formData });
            const result = await response.json();
            
            if (response.ok) {
                messageDiv.innerHTML = `
                    <div class="bg-green-100 text-green-700 p-4 rounded-2xl font-semibold animate-bounce-in">
                        <i class="fas fa-check-circle mr-2"></i>${result.message}
                    </div>
                `;
                this.reset();
                setTimeout(() => window.location.reload(), 2000);
            } else {
                messageDiv.innerHTML = `
                    <div class="bg-red-100 text-red-700 p-4 rounded-2xl font-semibold animate-bounce-in">
                        <i class="fas fa-exclamation-triangle mr-2"></i>${result.detail}
                    </div>
                `;
            }
        } catch (error) {
            messageDiv.innerHTML = `
                <div class="bg-red-100 text-red-700 p-4 rounded-2xl font-semibold animate-bounce-in">
                    <i class="fas fa-wifi mr-2"></i>Erreur de connexion
                </div>
            `;
        }
    });
    
    document.getElementById('retour-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        const empruntId = document.getElementById('emprunt-select').value;
        const messageDiv = document.getElementById('retour-message');
        
        if (!empruntId) {
            messageDiv.innerHTML = `
                <div class="bg-yellow-100 text-yellow-700 p-4 rounded-2xl font-semibold animate-bounce-in">
                    <i class="fas fa-exclamation-triangle mr-2"></i>Veuillez s√©lectionner un emprunt
                </div>
            `;
            return;
        }
        
        try {
            const response = await fetch(`/api/retours/${empruntId}`, { method: 'POST' });
            const result = await response.json();
            
            if (response.ok) {
                messageDiv.innerHTML = `
                    <div class="bg-green-100 text-green-700 p-4 rounded-2xl font-semibold animate-bounce-in">
                        <i class="fas fa-check-circle mr-2"></i>${result.message}
                    </div>
                `;
                this.reset();
                setTimeout(() => window.location.reload(), 2000);
            } else {
                messageDiv.innerHTML = `
                    <div class="bg-red-100 text-red-700 p-4 rounded-2xl font-semibold animate-bounce-in">
                        <i class="fas fa-exclamation-triangle mr-2"></i>${result.detail}
                    </div>
                `;
            }
        } catch (error) {
            messageDiv.innerHTML = `
                <div class="bg-red-100 text-red-700 p-4 rounded-2xl font-semibold animate-bounce-in">
                    <i class="fas fa-wifi mr-2"></i>Erreur de connexion
                </div>
            `;
        }
    });
    
    async function processReturn(empruntId) {
        const confirmed = await showCustomConfirm(
            'Confirmer le retour',
            '√ätes-vous s√ªr de vouloir enregistrer ce retour ?'
        );
        
        if (!confirmed) return;
        
        try {
            const response = await fetch(`/api/retours/${empruntId}`, { method: 'POST' });
            
            if (response.ok) {
                showNotification('Retour enregistr√© avec succ√®s', 'success');
                setTimeout(() => window.location.reload(), 1500);
            } else {
                const error = await response.json();
                showNotification(error.detail || 'Erreur lors du retour', 'error');
            }
        } catch (error) {
            showNotification('Erreur de connexion', 'error');
        }
    }
    
    function extendLoan(empruntId) {
        document.getElementById('extend-emprunt-id').value = empruntId;
        
        // Set minimum date to today
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('new-return-date').min = today;
        
        // Set default to 1 week from today
        const defaultDate = new Date();
        defaultDate.setDate(defaultDate.getDate() + 7);
        document.getElementById('new-return-date').value = defaultDate.toISOString().split('T')[0];
        
        document.getElementById('extend-modal').classList.remove('hidden');
    }
    
    function closeExtendModal() {
        document.getElementById('extend-modal').classList.add('hidden');
    }
    
    function sendReminder(empruntId) {
        showNotification('Rappel envoy√© √† l\'adh√©rent', 'success');
    }
    
    function refreshLoans() {
        window.location.reload();
    }
    
    function showQuickActions() {
        showNotification('Panneau d\'actions rapides en d√©veloppement', 'info');
    }
    
    function generateReport() {
        const headers = ['Adh√©rent', 'Email', 'Livre', 'Date emprunt', 'Date retour pr√©vue', 'Statut'];
        const rows = [];
        
        document.querySelectorAll('.loan-row').forEach(row => {
            const cells = row.querySelectorAll('td');
            const loanData = [
                cells[0]?.querySelector('.font-bold')?.textContent || '',
                cells[0]?.querySelector('.text-sm')?.textContent || '',
                cells[1]?.querySelector('.font-bold')?.textContent || '',
                cells[2]?.querySelector('.font-semibold')?.textContent || '',
                cells[2]?.querySelectorAll('.font-semibold')[1]?.textContent || '',
                row.dataset.status === 'late' ? 'En retard' : '√Ä temps'
            ];
            rows.push(loanData);
        });
        
        const csvContent = [headers, ...rows].map(row => 
            row.map(cell => `"${cell.replace(/"/g, '""')}"`).join(',')
        ).join('\n');
        
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `emprunts_rapport_${new Date().toISOString().split('T')[0]}.csv`;
        link.click();
        
        showNotification('Rapport g√©n√©r√© avec succ√®s', 'success');
    }
    
    function showCustomConfirm(title, message) {
        return new Promise((resolve) => {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50 animate-fade-in';
            modal.innerHTML = `
                <div class="glass-effect rounded-3xl p-8 max-w-md w-full border border-white/30 animate-bounce-in">
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 bg-blue-500 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-question-circle text-white text-2xl"></i>
                        </div>
                        <h3 class="text-xl font-bold text-gray-900 mb-2">${title}</h3>
                        <p class="text-gray-600 font-medium">${message}</p>
                    </div>
                    <div class="flex gap-4">
                        <button onclick="resolveConfirm(false)" class="flex-1 bg-gray-500 text-white py-3 px-6 rounded-2xl font-bold hover:bg-gray-600 transition duration-300">
                            <i class="fas fa-times mr-2"></i>Annuler
                        </button>
                        <button onclick="resolveConfirm(true)" class="flex-1 primary-button text-white py-3 px-6 rounded-2xl font-bold hover:scale-105 transform transition-all duration-300">
                            <i class="fas fa-check mr-2"></i>Confirmer
                        </button>
                    </div>
                </div>
            `;
            
            window.resolveConfirm = (result) => {
                modal.remove();
                resolve(result);
                delete window.resolveConfirm;
            };
            
            document.body.appendChild(modal);
        });
    }
    
    function showNotification(message, type) {
        const colors = {
            success: 'bg-green-500',
            error: 'bg-red-500',
            info: 'bg-blue-500'
        };
        
        const icons = {
            success: 'check-circle',
            error: 'exclamation-triangle',
            info: 'info-circle'
        };
        
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 z-50 p-4 rounded-2xl shadow-2xl font-semibold animate-bounce-in text-white ${colors[type] || colors.info}`;
        notification.innerHTML = `
            <div class="flex items-center">
                <i class="fas fa-${icons[type] || icons.info} mr-3"></i>
                ${message}
            </div>
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.opacity = '0';
            notification.style.transform = 'translateX(100px)';
            setTimeout(() => notification.remove(), 300);
        }, 4000);
    }
</script>
{% endblock %}