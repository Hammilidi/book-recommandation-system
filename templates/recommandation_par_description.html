{% extends "base.html" %}
{% block title %}Suggestions IA{% endblock %}
{% block content %}
<div class="animate-slide-up">
    <!-- Hero Section -->
    <div class="glass-effect rounded-3xl p-8 mb-8 border border-white/30 hover-lift">
        <div class="flex flex-col lg:flex-row items-center">
            <div class="lg:w-2/3 mb-6 lg:mb-0">
                <h1 class="gradient-text text-5xl font-black mb-4 leading-tight">
                    D√©couvrez avec l'IA ü§ñ
                </h1>
                <p class="text-gray-600 text-xl font-medium mb-6 leading-relaxed">
                    D√©crivez vos pr√©f√©rences et laissez notre intelligence artificielle vous recommander les livres parfaits pour vous.
                </p>
            </div>
            <div class="lg:w-1/3 flex justify-center">
                <div class="relative">
                    <div class="w-32 h-32 bg-gradient-to-br from-purple-500 via-pink-500 to-red-500 rounded-3xl rotate-12 floating-element shadow-2xl flex items-center justify-center">
                        <i class="fas fa-brain text-white text-5xl"></i>
                    </div>
                    <div class="absolute -top-3 -right-3 w-8 h-8 bg-yellow-400 rounded-full flex items-center justify-center shadow-lg">
                        <i class="fas fa-lightning-bolt text-white text-sm"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Recommendation Form -->
    <div class="glass-effect rounded-3xl p-8 mb-8 border border-white/30 hover-lift">
        <div class="max-w-4xl mx-auto">
            <h2 class="text-3xl font-black text-gray-800 mb-6 text-center flex items-center justify-center">
                <i class="fas fa-wand-magic-sparkles mr-3 text-purple-500"></i>D√©crivez votre livre id√©al
            </h2>
            
            <form id="reco-form" class="space-y-6">
                <div class="relative">
                    <label for="description-input" class="block text-gray-700 font-bold mb-3 text-lg">
                        Que recherchez-vous ?
                    </label>
                    <div class="relative">
                        <textarea id="description-input" rows="6" 
                                  class="w-full p-6 border-2 border-gray-200 rounded-3xl focus:ring-4 focus:ring-purple-200 focus:border-purple-500 transition-all duration-300 bg-white/90 backdrop-blur font-medium text-lg resize-none" 
                                  placeholder="Exemple : 'Un roman d'aventure historique se d√©roulant au 19√®me si√®cle avec un h√©ros charismatique, des myst√®res √† r√©soudre et une intrigue captivante. J'aime les histoires avec des rebondissements et une belle √©criture.'"></textarea>
                        <div class="absolute bottom-4 right-4 text-gray-400">
                            <i class="fas fa-pen-fancy text-xl"></i>
                        </div>
                    </div>
                </div>
                
                <!-- Quick suggestion buttons -->
                <div class="flex flex-wrap gap-3 justify-center">
                    <button type="button" class="suggestion-btn bg-blue-100 text-blue-700 px-4 py-2 rounded-full font-semibold hover:bg-blue-200 transition duration-300 shadow-md" 
                            data-text="Romance contemporaine avec une histoire d'amour touchante">
                        <i class="fas fa-heart mr-2"></i>Romance
                    </button>
                    <button type="button" class="suggestion-btn bg-red-100 text-red-700 px-4 py-2 rounded-full font-semibold hover:bg-red-200 transition duration-300 shadow-md" 
                            data-text="Thriller psychologique avec des rebondissements et du suspense">
                        <i class="fas fa-mask mr-2"></i>Thriller
                    </button>
                    <button type="button" class="suggestion-btn bg-green-100 text-green-700 px-4 py-2 rounded-full font-semibold hover:bg-green-200 transition duration-300 shadow-md" 
                            data-text="Science-fiction avec des technologies futuristes et des voyages spatiaux">
                        <i class="fas fa-rocket mr-2"></i>Sci-Fi
                    </button>
                    <button type="button" class="suggestion-btn bg-purple-100 text-purple-700 px-4 py-2 rounded-full font-semibold hover:bg-purple-200 transition duration-300 shadow-md" 
                            data-text="Fantasy √©pique avec magie, cr√©atures mythiques et qu√™tes h√©ro√Øques">
                        <i class="fas fa-hat-wizard mr-2"></i>Fantasy
                    </button>
                    <button type="button" class="suggestion-btn bg-yellow-100 text-yellow-700 px-4 py-2 rounded-full font-semibold hover:bg-yellow-200 transition duration-300 shadow-md" 
                            data-text="Biographie inspirante d'une personnalit√© remarquable">
                        <i class="fas fa-user-tie mr-2"></i>Biographie
                    </button>
                </div>
                
                <div class="text-center">
                    <button type="submit" class="primary-button text-white font-black py-4 px-12 rounded-3xl shadow-2xl hover:scale-105 transform transition-all duration-300 text-xl neon-glow">
                        <i class="fas fa-sparkles mr-3"></i>G√©n√©rer mes suggestions
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Loading State -->
    <div id="reco-loading" class="glass-effect rounded-3xl p-12 border border-white/30 text-center hidden animate-bounce-in">
        <div class="relative mx-auto mb-6 w-24 h-24">
            <div class="absolute inset-0 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full animate-spin"></div>
            <div class="absolute inset-2 bg-white rounded-full flex items-center justify-center">
                <i class="fas fa-brain text-purple-500 text-2xl"></i>
            </div>
        </div>
        <h3 class="text-2xl font-bold text-gray-800 mb-3">IA en cours d'analyse...</h3>
        <p class="text-gray-600 font-medium">Analyse de vos pr√©f√©rences et recherche des livres parfaits</p>
        <div class="flex justify-center items-center mt-6 space-x-2">
            <div class="w-3 h-3 bg-purple-500 rounded-full animate-pulse"></div>
            <div class="w-3 h-3 bg-pink-500 rounded-full animate-pulse" style="animation-delay: 0.2s;"></div>
            <div class="w-3 h-3 bg-red-500 rounded-full animate-pulse" style="animation-delay: 0.4s;"></div>
        </div>
    </div>

    <!-- Results Section -->
    <div id="reco-results-section" class="hidden">
        <div class="glass-effect rounded-3xl p-8 border border-white/30 hover-lift">
            <div class="text-center mb-8">
                <h2 class="text-3xl font-black text-gray-800 mb-3 flex items-center justify-center">
                    <i class="fas fa-stars mr-3 text-yellow-500"></i>Vos recommandations personnalis√©es
                </h2>
                <p class="text-gray-600 font-medium">S√©lectionn√©es sp√©cialement pour vous par notre IA</p>
            </div>
            
            <div id="reco-results" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
                <!-- Results will be populated here -->
            </div>
            
            <div class="text-center mt-8">
                <button id="get-more-suggestions" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold py-3 px-8 rounded-2xl shadow-lg hover:scale-105 transform transition-all duration-300">
                    <i class="fas fa-sync-alt mr-2"></i>Autres suggestions
                </button>
            </div>
        </div>
    </div>

    <!-- No Results State -->
    <div id="no-reco-results" class="glass-effect rounded-3xl p-12 border border-white/30 text-center hidden">
        <i class="fas fa-search-minus text-6xl text-gray-400 mb-6"></i>
        <h3 class="text-2xl font-bold text-gray-700 mb-3">Aucune recommandation trouv√©e</h3>
        <p class="text-gray-600 mb-6 font-medium">Essayez de modifier votre description ou d'√™tre plus sp√©cifique.</p>
        <button onclick="resetForm()" class="primary-button text-white px-6 py-3 rounded-2xl font-bold shadow-lg hover:scale-105 transform transition-all duration-300">
            <i class="fas fa-redo mr-2"></i>Nouvelle recherche
        </button>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Quick suggestion buttons
        document.querySelectorAll('.suggestion-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.getElementById('description-input').value = this.dataset.text;
                this.classList.add('animate-pulse');
                setTimeout(() => this.classList.remove('animate-pulse'), 500);
            });
        });
        
        // Form submission
        document.getElementById('reco-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const description = document.getElementById('description-input').value.trim();
            
            if (!description) {
                showNotification('Veuillez saisir une description', 'error');
                return;
            }
            
            // Show loading state
            showLoadingState();
            
            try {
                const response = await fetch('/api/recommander-par-description', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ description: description })
                });
                
                if (response.ok) {
                    const recommendations = await response.json();
                    hideLoadingState();
                    displayRecommendations(recommendations);
                } else {
                    const error = await response.json();
                    hideLoadingState();
                    showNoResults();
                    showNotification(error.detail || 'Erreur lors de la g√©n√©ration des recommandations', 'error');
                }
            } catch (error) {
                hideLoadingState();
                showNoResults();
                showNotification('Erreur de connexion', 'error');
            }
        });
    });
    
    function showLoadingState() {
        document.getElementById('reco-loading').classList.remove('hidden');
        document.getElementById('reco-results-section').classList.add('hidden');
        document.getElementById('no-reco-results').classList.add('hidden');
        
        // Scroll to loading section
        document.getElementById('reco-loading').scrollIntoView({
            behavior: 'smooth',
            block: 'center'
        });
    }
    
    function hideLoadingState() {
        document.getElementById('reco-loading').classList.add('hidden');
    }
    
    function displayRecommendations(recommendations) {
        const resultsContainer = document.getElementById('reco-results');
        const resultsSection = document.getElementById('reco-results-section');
        
        if (recommendations.length === 0) {
            showNoResults();
            return;
        }
        
        resultsContainer.innerHTML = '';
        
        recommendations.forEach((livre, index) => {
            const bookCard = document.createElement('div');
            bookCard.className = 'book-card rounded-3xl overflow-hidden shadow-xl hover-lift animate-fade-in';
            bookCard.style.animationDelay = `${index * 0.1}s`;
            
            bookCard.innerHTML = `
                <div class="relative overflow-hidden group">
                    <img src="${livre.image_url || '/static/default-book.jpg'}" alt="${livre.titre}" 
                         class="w-full h-64 object-cover group-hover:scale-110 transition-transform duration-500">
                    <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                    
                    <!-- AI Recommendation Badge -->
                    <div class="absolute top-4 left-4">
                        <span class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-3 py-1 rounded-full text-xs font-bold shadow-lg flex items-center">
                            <i class="fas fa-robot mr-1"></i>IA Recommand√©
                        </span>
                    </div>
                    
                    <!-- Status Badge -->
                    <div class="absolute top-4 right-4">
                        ${livre.disponibilite > 0 ? 
                            `<span class="bg-green-500 text-white px-3 py-1 rounded-full text-xs font-bold shadow-lg">
                                <i class="fas fa-check-circle mr-1"></i>Disponible
                            </span>` :
                            `<span class="bg-red-500 text-white px-3 py-1 rounded-full text-xs font-bold shadow-lg">
                                <i class="fas fa-clock mr-1"></i>R√©serv√©
                            </span>`
                        }
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="absolute bottom-4 left-4 right-4 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                        <div class="flex gap-2">
                            <a href="/livre/${livre.id}" class="flex-1 bg-white/90 backdrop-blur text-gray-800 py-2 px-4 rounded-xl font-semibold text-center hover:bg-white transition duration-300 shadow-lg">
                                <i class="fas fa-eye mr-2"></i>Voir d√©tails
                            </a>
                            ${livre.disponibilite > 0 ? 
                                `<button class="bg-blue-500/90 backdrop-blur text-white py-2 px-4 rounded-xl font-semibold hover:bg-blue-600 transition duration-300 shadow-lg" onclick="quickReserve(${livre.id})">
                                    <i class="fas fa-bookmark"></i>
                                </button>` : ''
                            }
                        </div>
                    </div>
                </div>
                
                <div class="p-6">
                    <h3 class="font-black text-xl text-gray-800 mb-2 leading-tight group-hover:text-purple-600 transition duration-300">
                        ${livre.titre}
                    </h3>
                    <p class="text-gray-600 font-medium mb-4 line-clamp-3">
                        ${livre.description ? livre.description.substring(0, 120) + (livre.description.length > 120 ? '...' : '') : 'Description non disponible'}
                    </p>
                    
                    <!-- Recommendation Score -->
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <span class="text-sm font-semibold text-purple-600">Pertinence IA:</span>
                            <div class="flex ml-2">
                                <i class="fas fa-star text-purple-400"></i>
                                <i class="fas fa-star text-purple-400"></i>
                                <i class="fas fa-star text-purple-400"></i>
                                <i class="fas fa-star text-purple-400"></i>
                                <i class="fas fa-star text-gray-300"></i>
                            </div>
                        </div>
                        <div class="text-sm text-gray-500 font-medium">
                            <i class="fas fa-copy mr-1"></i>${livre.disponibilite} ex.
                        </div>
                    </div>
                </div>
            `;
            
            resultsContainer.appendChild(bookCard);
        });
        
        resultsSection.classList.remove('hidden');
        
        // Scroll to results
        setTimeout(() => {
            resultsSection.scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
        }, 300);
    }
    
    function showNoResults() {
        document.getElementById('no-reco-results').classList.remove('hidden');
        document.getElementById('reco-results-section').classList.add('hidden');
    }
    
    function resetForm() {
        document.getElementById('description-input').value = '';
        document.getElementById('no-reco-results').classList.add('hidden');
        document.getElementById('reco-results-section').classList.add('hidden');
        
        // Scroll back to form
        document.getElementById('reco-form').scrollIntoView({
            behavior: 'smooth',
            block: 'center'
        });
    }
    
    async function quickReserve(livreId) {
        try {
            const response = await fetch(`/api/reservations/${livreId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            if (response.ok) {
                showNotification('R√©servation effectu√©e avec succ√®s !', 'success');
                // Update the card to show reserved status
                updateBookCardStatus(livreId, false);
            } else {
                const error = await response.json();
                showNotification(error.detail || 'Erreur lors de la r√©servation', 'error');
            }
        } catch (error) {
            showNotification('Erreur de connexion', 'error');
        }
    }
    
    function updateBookCardStatus(livreId, available) {
        // Update the book card UI to reflect new status
        const bookCards = document.querySelectorAll(`[onclick="quickReserve(${livreId})"]`);
        bookCards.forEach(card => {
            if (!available) {
                card.style.display = 'none';
                // Update status badge if needed
            }
        });
    }
    
    function showNotification(message, type) {
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 z-50 p-4 rounded-2xl shadow-2xl font-semibold animate-bounce-in ${
            type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
        }`;
        notification.innerHTML = `
            <div class="flex items-center">
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} mr-3"></i>
                ${message}
            </div>
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.opacity = '0';
            notification.style.transform = 'translateX(100px)';
            setTimeout(() => notification.remove(), 300);
        }, 4000);
    }
    
    // Character counter for textarea
    document.getElementById('description-input').addEventListener('input', function() {
        const maxLength = 500;
        const currentLength = this.value.length;
        
        // Remove existing counter
        const existingCounter = document.querySelector('.char-counter');
        if (existingCounter) existingCounter.remove();
        
        // Add character counter
        if (currentLength > 0) {
            const counter = document.createElement('div');
            counter.className = 'char-counter text-sm text-gray-500 mt-2 text-right font-medium';
            counter.textContent = `${currentLength}/${maxLength} caract√®res`;
            
            if (currentLength > maxLength * 0.9) {
                counter.classList.add('text-orange-500');
            }
            if (currentLength > maxLength) {
                counter.classList.add('text-red-500');
            }
            
            this.parentElement.appendChild(counter);
        }
    });
</script>

<style>
    .line-clamp-3 {
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    
    @keyframes pulse-glow {
        0%, 100% { box-shadow: 0 0 20px rgba(147, 51, 234, 0.3); }
        50% { box-shadow: 0 0 40px rgba(147, 51, 234, 0.6); }
    }
    
    .animate-pulse-glow {
        animation: pulse-glow 2s ease-in-out infinite;
    }
</style>
{% endblock %}